@using Microsoft.AspNetCore.Identity
@model ClashArt.Models.Post
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Artifact Details";
    var currentUser = await UserManager.GetUserAsync(User);
    var currentUserId = currentUser?.Id;
    bool isOwner = currentUserId != null && Model.UserId == currentUserId;
    bool isLikedByMe = Model.Likes != null && Model.Likes.Any(l => l.UserId == currentUserId);
}

<div class="min-h-[calc(100vh-80px)] flex items-center justify-center p-4">

    <div class="bg-[#1e1e1e] border border-white/10 rounded-2xl overflow-hidden shadow-2xl flex flex-col lg:flex-row w-full max-w-6xl h-auto lg:h-[800px]">

        <div class="w-full lg:w-[60%] bg-black flex items-center justify-center relative group">
            @if (!string.IsNullOrEmpty(Model.ProofOfWorkVideoUrl))
            {
                <video controls class="max-h-full max-w-full object-contain">
                    <source src="@Model.ProofOfWorkVideoUrl" type="video/mp4">
                </video>
            }
            else
            {
                <img src="@Model.ImageUrl" class="max-h-full max-w-full object-contain" alt="Artwork" />
            }

            <a href="javascript:history.back()" class="absolute top-4 left-4 bg-black/50 hover:bg-black/80 text-white p-2 rounded-full backdrop-blur-md transition">
                <span class="material-symbols-outlined">arrow_back</span>
            </a>
        </div>

        <div class="w-full lg:w-[40%] flex flex-col bg-[#1e1e1e] border-l border-white/10">

            <div class="p-4 border-b border-white/10 flex items-center justify-between bg-[#1e1e1e]">
                <a asp-controller="Users" asp-action="Profile" asp-route-id="@Model.UserId" class="flex items-center gap-3 group">
                    <div class="w-10 h-10 rounded-full overflow-hidden border border-white/20 group-hover:border-primary transition">
                        <img src="@(Model.User?.AvatarUrl ?? "https://i.pravatar.cc/150")" class="w-full h-full object-cover" />
                    </div>
                    <div>
                        <h4 class="font-bold text-white text-sm group-hover:text-primary transition">@Model.User?.DisplayName</h4>
                        <span class="text-xs text-gray-400">@Model.Theme?.Title</span>
                    </div>
                </a>

                @if (isOwner || User.IsInRole("Admin"))
                {
                    <div class="flex gap-2">
                        @if (isOwner)
                        {
                            <a asp-action="Edit" asp-route-id="@Model.Id" class="text-gray-400 hover:text-white"><span class="material-symbols-outlined text-sm">edit</span></a>
                        }
                        <form asp-action="Delete" asp-route-id="@Model.Id" method="post" onsubmit="return confirm('Delete post?');">
                            <button type="submit" class="text-gray-400 hover:text-red-500"><span class="material-symbols-outlined text-sm">delete</span></button>
                        </form>
                    </div>
                }
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-6 custom-scrollbar" style="max-height: calc(100% - 140px);">

                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                        <img src="@(Model.User?.AvatarUrl ?? "https://i.pravatar.cc/150")" class="w-full h-full object-cover" />
                    </div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-300">
                            <span class="font-bold text-white mr-1">@Model.User?.DisplayName</span>
                            @Model.Description
                        </p>
                        <span class="text-[10px] text-gray-500 mt-1 block">@Model.CreatedAt.ToString("MMM dd, yyyy")</span>
                    </div>
                </div>

                <div class="border-t border-white/5 my-2"></div>

                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="animate-pulse rounded-lg bg-red-500/10 border border-red-500/30 p-3 flex items-start gap-2 text-red-400 mb-4">
                        <span class="material-symbols-outlined text-[20px] shrink-0">gpp_bad</span>
                        <div>
                            <p class="text-xs font-bold uppercase tracking-wide">System Alert</p>
                            <p class="text-sm">@TempData["ErrorMessage"]</p>
                        </div>
                    </div>
                }

                @if (Model.Comments.Any())
                {
                    @foreach (var comment in Model.Comments)
                    {
                        <div class="flex gap-3 group">
                            <a asp-controller="Users" asp-action="Profile" asp-route-id="@comment.UserId" class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                                <img src="@(comment.User?.AvatarUrl ?? "https://i.pravatar.cc/150")" class="w-full h-full object-cover" />
                            </a>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <p class="text-sm text-gray-300">
                                        <span class="font-bold text-white mr-1">@comment.User?.DisplayName</span>
                                        @comment.Content
                                    </p>

                                    @if (currentUserId == comment.UserId || User.IsInRole("Admin"))
                                    {
                                        <form asp-controller="Comments" asp-action="Delete" asp-route-id="@comment.Id" method="post">
                                            <button type="submit" class="text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <span class="material-symbols-outlined text-[14px]">close</span>
                                            </button>
                                        </form>
                                    }
                                </div>
                                <span class="text-[10px] text-gray-500 mt-1 block">@comment.CreatedAt.ToString("HH:mm")</span>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center py-10 text-gray-600">
                        <span class="material-symbols-outlined text-4xl mb-2">chat_bubble_outline</span>
                        <p class="text-sm">No comments yet. Start the conversation.</p>
                    </div>
                }
            </div>

            <div class="p-4 border-t border-white/10 bg-[#1e1e1e]">

                <div class="flex items-center justify-between mb-3">
                    <div class="flex gap-4">
                        <form asp-controller="Home" asp-action="ToggleLike" method="post">
                            <input type="hidden" name="postId" value="@Model.Id" />
                            <input type="hidden" name="returnUrl" value="@Context.Request.Path" />
                            <button type="submit" class="hover:opacity-70 transition">
                                <span class="material-symbols-outlined text-2xl @(isLikedByMe ? "text-primary fill-current" : "text-white")"
                                      style="@(isLikedByMe ? "font-variation-settings: 'FILL' 1" : "")">
                                    favorite
                                </span>
                            </button>
                        </form>
                        <button onclick="document.getElementById('commentInput').focus()" class="hover:opacity-70 transition">
                            <span class="material-symbols-outlined text-2xl text-white">chat_bubble</span>
                        </button>
                    </div>
                    <span class="font-bold text-sm text-white">@Model.Likes?.Count likes</span>
                </div>

                @if (currentUserId != null)
                {
                    <form asp-controller="Comments" asp-action="Add" method="post" class="flex items-center gap-2">
                        <input type="hidden" name="postId" value="@Model.Id" />
                        <input type="text" id="commentInput" name="content" placeholder="Add a comment..." required
                               class="flex-1 bg-transparent border-none text-sm text-white placeholder-gray-500 focus:ring-0 px-0" autocomplete="off">
                        <button type="submit" class="text-primary font-bold text-sm hover:text-white transition uppercase">Post</button>
                    </form>
                }
                else
                {
                    <a asp-area="Identity" asp-page="/Account/Login" class="text-primary text-sm">Log in to comment</a>
                }
            </div>
        </div>
    </div>
</div>